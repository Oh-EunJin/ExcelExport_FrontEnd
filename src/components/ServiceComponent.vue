<template>
  <section class="page-section" id="services">
    <div class="container px-4 px-lg-5">
      <h2 class="text-center mt-0">ì‚¬ìš©í•´ë³´ê¸°</h2>
      <hr class="divider" />

      <div class="row gx-4 gx-lg-5">
        <div class="text-left">
          <h3 class="h4 mb-2">ìµœìƒìœ„ í´ë” ê²½ë¡œ</h3>
          <div class="mt-3">
            <label> ì ˆëŒ€ ê²½ë¡œ : <input type='text' v-model="dirPath" ref="dirPathCursor" style="min-width: 30rem;" /></label>
            <p style="margin-top: 0.5%;">* íŒŒì¼ ì •ë³´ë¥¼ ì•Œê³  ì‹¶ì€ ìµœìƒìœ„ í´ë”ì˜ ì ˆëŒ€ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. <br />
              ex) D:\Project\test
            </p>
          </div>
        </div>
      </div>

      <hr>

      <div class="row gx-4 gx-lg-5">
        <div class="col-lg-6 col-md-6 text-left">
          <h3 class="h4 mb-2">í™•ì¥ì</h3>
          <div class="mt-3 checkDiv" id="extCheckBox">
            <input type="checkbox" id="extJava" name="extension" value="java" />
            <label for="extJava"> java </label>
            
            <input type="checkbox" id="extJsp" name="extension" value="jsp" />
            <label for="extJsp"> jsp </label>

            <input type="checkbox" id="extJs" name="extension" value="js" />
            <label for="extJs"> js </label>

            <input type="checkbox" id="extVue" name="extension" value="vue" />
            <label for="extVue"> vue </label>

            <input type="checkbox" id="extEtc" name="extension" value="etc" />
            <label for="extEtc"> ê¸°íƒ€ <input type="text" v-model="etcList" ref="etcListCursor" /></label>
          </div>
          <div class="mt-2">
            <p>* ê¸°íƒ€ ì„ íƒ ì‹œ ê²€ìƒ‰í•˜ê³ ì í•˜ëŠ” í™•ì¥ìë¥¼ ì…ë ¥í•´ ì£¼ì‹œê³ , ì—¬ëŸ¬ ê°œì¸ ê²½ìš° ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ êµ¬ë¶„ì(/)ë¥¼ í¬í•¨í•˜ì—¬ ì…ë ¥í•´ ì£¼ì„¸ìš”. <br />
                ex) css/xml/html</p>
          </div>
        </div>

        <div class="col-lg-6 col-md-6 text-left">
          <h3 class="h4 mb-2">ë‚ ì§œ</h3>
          <div class="mt-3">
            <!-- <label for="date"> ë‚ ì§œ </label> -->
            <!-- <input type="date" id="date" :max="maxDate" /> -->
            
            <Datepicker class="datepicker" v-model="pickDate" :locale="locale" :weekStartsOn="0"
                        :disabledDates="{ predicate: isTodayOver }" placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”." :clearable="true" >
              <template v-slot:clear="{ onClear }">
                <button class="openBtn" type="button" @click="openCalendar">ğŸ—“ï¸</button>
                <button class="clearBtn" type="button" @click="onClear">x</button>
              </template>
            </Datepicker>
          </div>
          <div class="mt-2">
            <p>* ë‚ ì§œ ì„ íƒ ì‹œ í•´ë‹¹ ë‚ ì§œ ì´í›„ì— ìˆ˜ì •ëœ íŒŒì¼ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <hr>

      <div class="row gx-4 gx-lg-5">
        <div class="col-lg-6 col-md-6 text-left">
          <h3 class="h4 mb-2">ì—‘ì…€ Header</h3>
          <div class="mt-3 checkDiv">
            <input type="checkbox" id="No" name="headerName" value="No" checked disabled />
            <label for="No"> No </label>

            <input type="checkbox" id="path" name="headerName" value="path" checked disabled />
            <label for="path"> ê²½ë¡œ </label>

            <input type="checkbox" id="fileName" name="headerName" value="fileName" checked disabled />
            <label for="fileName"> íŒŒì¼ëª… </label>

            <input type="checkbox" id="exten" name="headerName" value="exten" />
            <label for="exten"> í™•ì¥ì </label>
            
            <input type="checkbox" id="updateDate" name="headerName" value="updateDate" />
            <label for="updateDate"> ìˆ˜ì •ì¼ </label>
          </div>
        </div>
      </div>

      <hr>

      <!-- css ê´€ë ¨ checkbox ì˜ì—­
      TO-BE : css ê´€ë ¨ ê°œë°œì€ ì¶”í›„ ê°œë°œ ì˜ˆì •
      <div class="row gx-4 gx-lg-5">
        <div class="col-lg-6 col-md-6 text-left">
          <h3 class="h4 mb-2">Header CSS</h3>
          <div class="mt-3">
            <input type="checkbox" id="check3" name="checkName3" value="checkVal3" />
            <label for="check3"> í…Œë‘ë¦¬ êµµê²Œ </label>
            
            <input type="checkbox" id="check33" name="checkName3" value="checkVal33" />
            <label for="check33"> ìƒ‰ìƒ </label>
          </div>
        </div>

        <div class="col-lg-6 col-md-6 text-left">
          <h3 class="h4 mb-2">Body CSS</h3>
          <div class="mt-3">
            <input type="checkbox" id="check4" name="checkName4" value="checkVal4" />
            <label for="check4"> No </label>
          </div>
        </div>
      </div> -->

      <hr>

      <div class="text-center">
        <button class="btn btn-primary2 btn-xl" type="button" @click="downExcel()" :disabled="isDownBtnDisabled">Download</button>
      </div>

    </div>

    <AlertComponent v-if="isOpenAlert" :message="message" :isOpenAlert="isOpenAlert" :icon="iconState" />
    <LoadingComponent :isLoading="loadingStatus" />
</section>
</template>

<script>
import { ref, reactive } from 'vue';
import Datepicker from 'vue3-datepicker';
import { ko } from 'date-fns/locale';

import { mapState } from 'vuex';

export default {
  name: 'ServiceComponent',
  components: {
    Datepicker,
  },
  data() {
    return {
      dirPath: '',
      etcList: '',
      pickDate: ref(),
      locale: reactive(ko),

      sendData: {},

      isDownBtnDisabled: false,
    };
  },
  methods: {
    // TO-BE : custom alertë„ í•´ë³´ê¸°......
    // ë‹¬ë ¥ ì„ íƒ í˜¸ì¶œ
    openCalendar() {
      document.querySelector('.datepicker').focus();
    },
    // ì–´ì œ ë‚ ì§œê¹Œì§€ ì„ íƒ ê°€ëŠ¥
    isTodayOver(date) {
      return date > new Date(new Date().setDate(new Date().getDate()-1));
    },
    // ìœ íš¨ì„± ì²´í¬
    checkValidation() {
      this.sendData = {};

      // ì ˆëŒ€ ê²½ë¡œ ìœ íš¨ì„± ì²´í¬
      if(this.dirPath.length < 1) {
        this.openAlert('í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'warn');
        // alert('í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.')
        this.$refs.dirPathCursor.focus();
        return false;
      } else {
        const lastVal = this.dirPath[this.dirPath.length - 1];
        if(lastVal == '\\') {
          this.dirPath = this.dirPath.substring(0, this.dirPath.length-1);
        }
        this.sendData.dirPath = this.dirPath;
      }

      // í™•ì¥ì ìœ íš¨ì„± ì²´í¬
      const checkBoxes = document.querySelectorAll('input[name="extension"]:checked');
      var extCnt = checkBoxes.length;
      // ìµœì†Œ 1ê°œ ì„ íƒ ì²´í¬
      if(extCnt < 1) {
        this.openAlert('í™•ì¥ìë¥¼ ìµœì†Œ 1ê°œ ì„ íƒí•´ ì£¼ì„¸ìš”.', 'warn');
        return false;
      }
      // ê¸°íƒ€ ì„ íƒ ì‹œ input ê°’ ìœ íš¨ì„± ì²´í¬ ë° ê°’ ì €ì¥
      let isCheckValidation = true;
      checkBoxes.forEach(item => {
        if(item.value != 'etc') {
          if(this.sendData.etcList) {
            this.sendData.etcList = this.sendData.etcList + "/" + item.value;
          } else {
            this.sendData.etcList = item.value;
          }
        } else {
          if(this.etcList.length < 1) {
            this.openAlert('í™•ì¥ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'warn');
            this.$refs.etcListCursor.focus();
            isCheckValidation = false;
          } else {
            // checkëœ item ë¦¬ìŠ¤íŠ¸ ì €ì¥
            if(this.sendData.etcList) {
              this.sendData.etcList = this.sendData.etcList + "/" + this.etcList;
            } else {
              this.sendData.etcList = this.etcList;
            }
          }
        }
      });

      if(!isCheckValidation) {
        return false;
      }

      // ë‚ ì§œ ì„ íƒ ì‹œ ê°’ ì €ì¥
      if(this.pickDate) {
        const year = this.pickDate.getFullYear();
        const month = String(this.pickDate.getMonth() + 1).padStart(2, "0");
        const day = String(this.pickDate.getDate()).padStart(2, "0");
        this.sendData.pickDate = `${year}-${month}-${day}`;
      }

      // ì—‘ì…€ Header ê°’ ì €ì¥
      const headerChkList = document.querySelectorAll('input[name="headerName"]:checked');
      headerChkList.forEach(item => {
        if(this.sendData.headerList) {
          this.sendData.headerList = this.sendData.headerList + "/" + item.nextElementSibling.outerText;
        } else {
          this.sendData.headerList = item.nextElementSibling.outerText;
        }
      });

      return true;
    },
    openAlert(msg, icon) {
      const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
      document.body.style.overflow = "hidden";
      document.body.style.paddingRight = `${scrollBarWidth}px`;
      this.$store.dispatch("openAlertComponent", { msg: msg, icon: icon });
    },
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    downExcel() {
      if(this.checkValidation()) {
        this.isDownBtnDisabled = true;

        this.$axios.get("/api/excel",{ params: this.sendData, responseType: 'blob' }).then(async (res) => {
          
          const contentType = res.headers["content-type"];
          if (contentType.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")) {
            const url = window.URL.createObjectURL(
              new Blob([res.data], 
              { type: res.headers["content-type"] })
            );
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "ì´í–‰ëª©ë¡" + ".xlsx");
            document.body.appendChild(link);
            link.click();
  
            // ì„±ê³µ ë©”ì‹œì§€
            this.openAlert('ë‹¤ìš´ë¡œë“œ ì„±ê³µ', 'success');
          } else {
            const errorMessage = await res.data.text();
            this.openAlert(errorMessage, "warn");
          }
        }).catch(() => {
          this.openAlert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'warn');
        }).finally(() => {
          this.$store.commit('loadingComponent', false);
          this.isDownBtnDisabled = false;
        });
      }
    }
  },
  watch: {
    dirPath(newVal) {
      this.dirPath = newVal.replace(/[\s/]/g, "");    // íŠ¹ìˆ˜ë¬¸ì(ë„ì–´ì“°ê¸°, /)ì…ë ¥ ë°©ì§€
    },
    etcList(newValue) {
      const allowedPattern = /^[A-Za-z/]*$/;

      if (!allowedPattern.test(newValue)) {
        this.etcList = newValue.replace(/[^A-Za-z/]/g, "");
      }

      if (this.etcList.length > 0) {
        document.querySelector("#extEtc").checked = true;
      } else {
        document.querySelector("#extEtc").checked = false;
      }
    },
    pickDate: function() {
      document.querySelector('.datepicker').blur();
    }
  },
  computed: {
    ...mapState(["isOpenAlert", "message", "iconState", "loadingStatus"]),

    /**
    * input ì—ì„œ datepickerë¡œ ìˆ˜ì •í•˜ì—¬ í•´ë‹¹ ë¶€ë¶„ ì£¼ì„ ì²˜ë¦¬
    // ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ëŠ” ë¹„í™œì„±í™” ì²˜ë¦¬
    maxDate() {
      const today = new Date(Date.now() - new Date().getTimezoneOffset()*60000);
      return new Date(today.setDate(today.getDate()-1)).toISOString().split("T")[0];
    }
    */
  },
}
</script>

<style scoped>
label, input[type="checkbox"] {
  cursor: pointer;
}
.checkDiv > input {
  margin-right: 0.5%;
}
.checkDiv > label {
  margin-right: 2%;
}

input[type="text"] {
  padding-left: 5px;
}

.openBtn {
  background-color:transparent;
  border: none;
  margin-left: -9rem;
}
.clearBtn {
  background-color:transparent;
  border: none;
  color: red;
  margin-left: 6.3rem;
}

input[type="checkbox"] {
  appearance: none; /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
  width: 16px;
  height: 16px;
  border: 2px solid gray; /* ê¸°ë³¸ í…Œë‘ë¦¬ */
  border-radius: 4px;
  background-color: white; /* ë°°ê²½ìƒ‰ì€ í°ìƒ‰ ìœ ì§€ */
  position: relative;
}
input[type="checkbox"]:disabled {
  border: 2px solid rgb(118, 154, 21);
  background-color: rgb(223, 223, 223);
}
input[type="checkbox"]:checked::after {
  content: ''; 
  position: absolute;
  width: 10px;
  height: 5px;
  border: solid red; /* ì²´í¬ í‘œì‹œ ìƒ‰ìƒ */
  border-width: 0 0 2px 2px; 
  transform: rotate(-45deg);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -65%) rotate(-45deg);
}
input[type="checkbox"]:disabled, input[type="checkbox"]:disabled + label {
  cursor: default;
}

</style>